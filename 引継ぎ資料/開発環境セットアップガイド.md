# 開発環境セットアップガイド

本ドキュメントは、ノベルゲームアプリケーションの開発環境構築手順をまとめた引継ぎ資料です。

---

## 目次

1. [必要な環境](#必要な環境)
2. [ローカル開発サーバーの起動](#ローカル開発サーバーの起動)
3. [Dropbox連携設定](#dropbox連携設定)
4. [ディレクトリ構成](#ディレクトリ構成)
5. [開発ワークフロー](#開発ワークフロー)
6. [トラブルシューティング](#トラブルシューティング)

---

## 必要な環境

### 1. ブラウザ

- **Chrome / Edge**: 推奨（Service Worker、Cache Storage対応）
- **Firefox**: 動作確認済み
- **Safari**: 一部制限あり（開発者モード推奨）

### 2. 開発ツール

#### Visual Studio Code（推奨）
- **拡張機能**:
  - Live Server
  - ESLint
  - Prettier

#### Node.js（React移行時）
- **バージョン**: 18.x 以上
- **パッケージマネージャー**: npm / yarn / pnpm

---

## ローカル開発サーバーの起動

### 方法1: VS Code Live Server（推奨）

1. VS Codeで `NovelGame01_vol1` フォルダを開く
2. `index.html` を右クリック → "Open with Live Server"
3. ブラウザで `http://127.0.0.1:5500/NovelGame01_vol1/` が開く

### 方法2: Python簡易サーバー

```bash
# Python 3の場合
cd NovelGame01_vol1
python -m http.server 8000

# ブラウザで http://localhost:8000 にアクセス
```

### 方法3: Node.js http-server

```bash
# インストール
npm install -g http-server

# 起動
cd NovelGame01_vol1
http-server -p 8000

# ブラウザで http://localhost:8000 にアクセス
```

### ⚠️ CORS制限について

**file://** プロトコルで直接HTMLを開くと、以下のエラーが発生します：

```
Access to fetch at 'file:///...' from origin 'null' has been blocked by CORS policy
```

**解決策**: 必ずローカルサーバー経由でアクセスしてください。

---

## Dropbox連携設定

### 1. Dropboxアプリの作成

1. [Dropbox App Console](https://www.dropbox.com/developers/apps) にアクセス
2. "Create app" をクリック
3. 設定:
   - **API**: Scoped access
   - **Access**: Full Dropbox（推奨） または App folder
   - **Name**: 任意の名前（例: `NovelGameAssets`）
4. "Create app" をクリック

### 2. アプリ設定

#### Permissions タブ
必要な権限にチェック:
- ✅ `files.metadata.read`
- ✅ `files.content.read`

"Submit" をクリックして保存。

#### Settings タブ

**OAuth 2 → Redirect URIs** に以下を追加:
```
http://127.0.0.1:5500/NovelGame01_vol1/
http://localhost:8000/
```

※ 使用するローカルサーバーのURLに合わせて調整

**App key** をコピー（後で使用）

### 3. アプリケーション側の設定

`src/config.js` を編集:

```javascript
window.DROPBOX_CONFIG = {
  APP_KEY: 'あなたのApp Key'  // ← ここに貼り付け
};
```

### 4. Dropboxフォルダ構成

Dropboxに以下のフォルダを作成:

```
Dropbox/
└─ GameAssets/           # または Apps/NovelGameAssets/
    ├─ 00_TitleImage/
    ├─ 01_bg/
    ├─ 02_character/
    ├─ 03_Sound/
    ├─ 04_enemy/
    ├─ 05_Item/
    └─ 06_UI/
```

**注意**: 
- **Full Dropbox**: ルート直下に `GameAssets` フォルダ
- **App folder**: `Apps/NovelGameAssets/` が自動的にルートになる

---

## ディレクトリ構成

```
NovelGame01_vol1/
├─ index.html              # メインHTML
├─ style.css               # スタイル定義
├─ sw.js                   # Service Worker
├─ manifest.json           # PWA マニフェスト
│
├─ icons/                  # PWAアイコン
│   ├─ icon-192.png
│   └─ icon-512.png
│
├─ data/                   # ゲームデータ
│   ├─ episodes.json
│   ├─ scenario.json
│   └─ gallery.json
│
├─ src/                    # スクリプト
│   ├─ config.js           # Dropbox設定
│   └─ screens/
│       └─ AssetImportScreen.js
│
├─ assets/                 # ローカルアセット
│   ├─ title/
│   ├─ bg/
│   ├─ chara/
│   ├─ enemy/
│   ├─ item/
│   ├─ ui/
│   └─ sound/
│       ├─ bgm/
│       └─ se/
│
└─ 00_doc/                 # ドキュメント
    └─ 引継ぎ資料/
        ├─ React移行_レイアウト仕様書.md
        ├─ データ構造＆API仕様書.md
        └─ 開発環境セットアップガイド.md
```

---

## 開発ワークフロー

### 1. 初回セットアップ

```bash
# リポジトリクローン
git clone https://github.com/SHUNSUKE-Ks/NovelGameList_Vol1
cd NovelGame01_vol1

# Dropbox設定
# src/config.js を編集

# ローカルサーバー起動
# （方法は上記参照）
```

### 2. データ編集

#### episodes.json
- チャプター・イベント追加

#### scenario.json
- シナリオノード追加
- storyIDは1000番台推奨（重複なし）

#### gallery.json
- ギャラリー画像メタデータ追加

### 3. スタイル変更

`style.css` を編集:
- CSS変数（`:root`）でカラー・フォント調整
- 各画面のクラス名でレイアウト調整

### 4. Service Worker更新

キャッシュをクリアする場合:

```javascript
// sw.js
const CACHE_NAME = 'novel-game-v5'; // ← バージョンアップ
```

ブラウザで強制リロード（Ctrl + Shift + R）

### 5. Git操作

```bash
# 変更をステージング
git add .

# コミット
git commit -m "機能追加: ○○"

# プッシュ
git push
```

---

## トラブルシューティング

### Q1. 画面が真っ白になる

**原因**: JSONファイルの構文エラー、またはCORS制限

**解決策**:
1. ブラウザの Developer Tools → Console でエラー確認
2. JSONファイルを [JSONLint](https://jsonlint.com/) で検証
3. ローカルサーバー経由でアクセスしているか確認

### Q2. Dropbox接続後、画面が古いバージョンに戻る

**原因**: Service Workerが古いキャッシュを返している

**解決策**:
1. `sw.js` のバージョン番号を変更
2. ブラウザで `Ctrl + Shift + R` で強制リロード
3. Developer Tools → Application → Service Workers → "Unregister"

### Q3. Dropbox 409 Conflict エラー

**原因**: 指定したフォルダ `/GameAssets` が存在しない

**解決策**:
1. Dropboxアプリの権限を確認（Full Dropbox vs App folder）
2. フォルダ名を確認（`GameAssets` vs `GameAsset`）
3. `AssetImportScreen.js` の `checkAuthCallback()` で初期パスを調整

### Q4. Service Workerが更新されない

**原因**: ブラウザキャッシュ

**解決策**:
```javascript
// Developer Tools → Application → Service Workers
// "Update on reload" にチェック
// または "Unregister" → リロード
```

### Q5. Dropboxの画像が表示されない

**原因**: Cache Storageへの保存失敗、またはService Workerの配信ルート不一致

**解決策**:
1. Developer Tools → Application → Cache Storage で確認
2. `sw.js` の `/assets/` ルート処理を確認
3. `AssetImportScreen.js` の `virtualPath` 生成ロジックを確認

---

## 開発推奨ツール

### 1. ブラウザ拡張機能

- **JSON Formatter**: JSON表示を見やすく
- **React Developer Tools**: React移行後に使用
- **Redux DevTools**: 状態管理デバッグ

### 2. VSCode拡張機能

- **Live Server**: ローカルサーバー
- **Prettier**: コード整形
- **ESLint**: コードチェック
- **Path Intellisense**: パス補完
- **Material Icon Theme**: アイコンテーマ

### 3. オンラインツール

- [JSONLint](https://jsonlint.com/): JSON検証
- [Can I Use](https://caniuse.com/): ブラウザ互換性確認
- [CSS Gradient Generator](https://cssgradient.io/): グラデーション生成

---

## React移行時の追加セットアップ

### 1. プロジェクト作成

```bash
# Vite + React + TypeScript
npm create vite@latest novel-game-react -- --template react-ts
cd novel-game-react
npm install
```

### 2. 依存関係インストール

```bash
# 状態管理
npm install zustand

# Dropbox SDK
npm install dropbox

# ルーティング（必要に応じて）
npm install react-router-dom
```

### 3. 既存データ移行

```bash
# dataフォルダをコピー
cp -r ../NovelGame01_vol1/data ./public/

# assetsフォルダをコピー
cp -r ../NovelGame01_vol1/assets ./public/
```

### 4. Service Worker設定

Viteの`vite-plugin-pwa`を使用:

```bash
npm install -D vite-plugin-pwa
```

`vite.config.ts`:
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: '理の魔法使い',
        short_name: '理の魔法使い',
        // ... その他の設定
      }
    })
  ]
})
```

---

以上が、開発環境セットアップガイドです。不明点があれば、各種ドキュメントを参照してください。
